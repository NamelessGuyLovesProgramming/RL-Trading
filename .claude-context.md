#!/bin/bash

# ================================================================================
# CLAUDE CODE SETUP FÜR RL TRADING SYSTEM
# ================================================================================
# Dieses Script bereitet dein Projekt für Claude Code vor
# und zeigt dir, wie du effektiv mit Claude Code arbeitest

# 1. INSTALLATION VON CLAUDE CODE
# -------------------------------- 
echo "=== Claude Code Installation ==="
echo "Falls noch nicht installiert:"
echo "pip install claude-code"
echo ""

# 2. PROJEKT STRUKTUR ERSTELLEN
# ------------------------------
echo "=== Erstelle Projektstruktur ==="

mkdir -p rl-trading-system/{src,data,models,configs,notebooks,tests}

cd rl-trading-system

# 3. ERSTELLE PROJEKT-KONTEXT DATEI FÜR CLAUDE
# ---------------------------------------------
cat > .claude-context.md << 'EOF'
# RL Trading System - Projekt Kontext

## Projekt Übersicht
Ein interaktives Reinforcement Learning Trading System mit Human-in-the-Loop Feedback,
inspiriert vom Trackmania-Beispiel wo KI durch gezieltes Reward Shaping spezifisches 
Verhalten (wie Driften) lernt.

## Kern-Features
1. **Modulare Reward-Komponenten**: PnL, FVG, Order Blocks, Human Feedback
2. **Reward Shaping**: Gezielte Belohnungen für spezifische Trading-Patterns
3. **Human-in-the-Loop**: Manuelles Feedback für Trades
4. **Pattern Detection**: Fair Value Gaps, Order Blocks, Liquidity Zones

## Aktuelle Ziele
- [ ] Integration mit echten Marktdaten (Binance API, yfinance)
- [ ] PPO/SAC Agent Implementation mit Stable-Baselines3
- [ ] Erweiterte Trading Patterns (Liquidity Zones, Imbalances)
- [ ] Live Paper Trading Modus
- [ ] Performance Dashboard mit Streamlit

## Technischer Stack
- Python 3.9+
- gymnasium (OpenAI Gym)
- stable-baselines3
- pandas, numpy
- ccxt (für Crypto APIs)
- yfinance (für Aktien)
- streamlit (für UI)

## Wichtige Dateien
- `src/env.py`: Trading Environment mit Reward Shaping
- `src/rewards.py`: Modulare Reward-Komponenten
- `src/patterns.py`: Pattern Detection (FVG, Order Blocks)
- `src/agent.py`: RL Agent Wrapper
- `src/data_feed.py`: Live/Historical Data Integration
EOF

# 4. ERSTELLE HAUPT-PROMPT FÜR CLAUDE CODE
# -----------------------------------------
cat > CLAUDE_PROMPTS.md << 'EOF'
# Claude Code Prompts für RL Trading System

## 1. PATTERN ERWEITERUNG
```
Erweitere src/patterns.py um folgende Trading-Patterns:
1. Liquidity Zones: Bereiche mit hohem Volumen wo Stops liegen
2. Imbalances/Inefficiencies: Schnelle Bewegungen die gefüllt werden
3. Market Structure Breaks: Wenn Higher Highs/Lower Lows gebrochen werden
4. Volume Profile POC (Point of Control)

Jedes Pattern soll:
- Eine detect_* Methode haben
- Confidence Score zurückgeben (0-1)
- Visualisierbar sein (plot_* Methode)
```

## 2. BINANCE INTEGRATION
```
Implementiere in src/data_feed.py:
1. BinanceDataFeed Klasse mit ccxt
2. Live Kerzendaten-Stream (websocket)
3. Historical Data Download
4. Multi-Timeframe Support (1m, 5m, 15m, 1h)
5. Fehlerbehandlung und Reconnect-Logik
```

## 3. PPO AGENT MIT HUMAN FEEDBACK
```
Erstelle src/agent.py mit:
1. PPO Agent der Human Feedback nutzt
2. Custom Callback für periodisches Feedback
3. Speichern/Laden von Checkpoints
4. Wandb Integration für Tracking
5. Replay Buffer für Human Demonstrations
```

## 4. STREAMLIT DASHBOARD
```
Baue dashboard.py mit:
1. Live Trading Visualisierung
2. Pattern Overlay (FVGs, Order Blocks)
3. Feedback Interface (Gut/Schlecht Buttons)
4. Performance Metriken (Sharpe, Win Rate, PnL)
5. Reward Weight Adjustment Slider
```

## 5. BACKTESTING ENGINE
```
Implementiere src/backtest.py:
1. Walk-Forward Analysis
2. Multiple Timeframe Testing
3. Slippage & Commission Simulation
4. Monte Carlo Simulation
5. Performance Report Generation
```
EOF

# 5. ERSTELLE REQUIREMENTS.TXT
# -----------------------------
cat > requirements.txt << 'EOF'
# Core RL
gymnasium>=0.29.0
stable-baselines3>=2.0.0
tensorboard>=2.14.0

# Data & Trading
pandas>=2.0.0
numpy>=1.24.0
ccxt>=4.0.0
yfinance>=0.2.28
python-binance>=1.0.17
websocket-client>=1.6.0

# Technical Analysis
ta>=0.10.2
pandas-ta>=0.3.14b0

# Visualization
matplotlib>=3.7.0
plotly>=5.17.0
streamlit>=1.28.0
mplfinance>=0.12.10b0

# ML & Optimization
scikit-learn>=1.3.0
optuna>=3.4.0
wandb>=0.15.0

# Utils
pyyaml>=6.0
python-dotenv>=1.0.0
loguru>=0.7.0
pytest>=7.4.0
EOF

# 6. ERSTELLE ENV DATEI TEMPLATE
# -------------------------------
cat > .env.template << 'EOF'
# Binance API (für Crypto Trading)
BINANCE_API_KEY=your_api_key_here
BINANCE_API_SECRET=your_api_secret_here

# Paper Trading Settings
PAPER_TRADING_ENABLED=true
INITIAL_BALANCE=10000

# Model Settings
MODEL_CHECKPOINT_DIR=./models
TENSORBOARD_LOG_DIR=./logs

# Wandb (optional)
WANDB_API_KEY=your_wandb_key
WANDB_PROJECT=rl-trading
EOF

# 7. CLAUDE CODE BEFEHLE
# -----------------------
cat > CLAUDE_CODE_COMMANDS.md << 'EOF'
# Claude Code Befehle für das Projekt

## Basis Setup
```bash
# Initialisiere Claude Code im Projekt
claude-code init

# Setze Projekt-Kontext
claude-code context .claude-context.md
```

## Entwicklungs-Befehle

### 1. Neues Feature hinzufügen
```bash
# Pattern Detection erweitern
claude-code add "Implementiere Liquidity Zone Detection in src/patterns.py. 
Die Zones sollen Bereiche mit hohem Volumen identifizieren wo vermutlich 
Stop-Losses liegen. Nutze Volume Profile und Price Action."

# Binance Integration
claude-code add "Integriere Binance API in src/data_feed.py mit ccxt. 
Implementiere sowohl historical data download als auch live websocket stream."
```

### 2. Code Review & Verbesserung
```bash
# Review existing code
claude-code review src/env.py --suggest-improvements

# Refactor für bessere Performance
claude-code refactor src/rewards.py --optimize-performance
```

### 3. Tests erstellen
```bash
# Unit Tests generieren
claude-code test src/patterns.py --create-tests

# Integration Tests
claude-code test src/data_feed.py --integration
```

### 4. Debugging
```bash
# Debug spezifisches Problem
claude-code debug "Der Agent traded nicht in FVG Zones obwohl 
reward weight hoch ist" --files src/env.py,src/rewards.py
```

### 5. Dokumentation
```bash
# Generiere Docs
claude-code docs src/ --format markdown

# API Dokumentation
claude-code docs src/agent.py --api-docs
```

## Erweiterte Workflows

### Complete Feature Implementation
```bash
# Schritt 1: Plan erstellen
claude-code plan "Implementiere komplettes Liquidity Trading Feature"

# Schritt 2: Implementieren
claude-code implement --from-plan

# Schritt 3: Tests
claude-code test --all

# Schritt 4: Dokumentation
claude-code docs --update
```

### Live Coding Session
```bash
# Interaktiver Modus
claude-code interactive

# Mit spezifischem Fokus
claude-code interactive --focus "Pattern Detection Verbesserung"
```

## Spezielle Trading Commands

### Strategy Development
```bash
claude-code create-strategy "Mean Reversion in FVG Zones" \
  --base-on src/strategies/template.py \
  --patterns fvg,liquidity \
  --risk-management kelly-criterion
```

### Backtest Analysis
```bash
claude-code analyze-backtest results/backtest_001.json \
  --suggest-improvements \
  --compare-with results/baseline.json
```

### Live Trading Preparation
```bash
claude-code prepare-live \
  --check-safety \
  --suggest-parameters \
  --create-monitoring
```
EOF

# 8. BEISPIEL CLAUDE CODE SESSION
# --------------------------------
cat > example_session.sh << 'EOF'
#!/bin/bash

# Beispiel einer kompletten Claude Code Session

echo "=== Starting Claude Code RL Trading Development ==="

# 1. Initialisierung
claude-code init
claude-code context .claude-context.md

# 2. Implementiere Liquidity Zones
claude-code add "
Implementiere in src/patterns.py eine LiquidityZoneDetector Klasse:
1. Identifiziere High Volume Nodes (HVN) aus Volume Profile
2. Markiere Zonen wo Price schnell durchgegangen ist (Low Volume Nodes)
3. Finde ungetestete Liquidity Zones die als Magnet wirken könnten
4. Confidence Score basierend auf Volume und Anzahl der Touches
5. Methode get_nearest_zone(current_price) die nächste Zone zurückgibt
"

# 3. Erweitere Reward System
claude-code add "
Erweitere src/rewards.py um LiquidityZoneReward:
- Große Belohnung wenn Trade IN Richtung einer Liquidity Zone geht
- Extra Bonus wenn Zone erreicht und Price reagiert
- Negativ wenn Trade GEGEN starke Liquidity Zone
"

# 4. Binance Live Data
claude-code add "
Implementiere src/data_feed.py:
class BinanceLiveFeed:
    - Websocket connection für Realtime Kerzendaten
    - Buffer für die letzten 1000 Kerzen
    - Automatic reconnection bei Verbindungsabbruch
    - Multi-Symbol Support (BTC, ETH, etc.)
    - Callback System für neue Kerzen
"

# 5. PPO Agent mit Custom Features
claude-code add "
Erstelle src/agent.py mit TradingPPO(PPO):
- Custom Feature Extractor der Pattern-Signale nutzt
- Episodic Memory für erfolgreiche Trades in bestimmten Patterns
- Adaptive Learning Rate basierend auf Performance
- Integration von Human Feedback in Loss Function
"

# 6. Tests generieren
claude-code test src/patterns.py --create-tests
claude-code test src/data_feed.py --integration

# 7. Dashboard bauen
claude-code add "
Baue streamlit_app.py:
- Zwei Modi: Training Überwachung und Live Trading
- Chart mit Candlesticks und Pattern Overlays
- Feedback Buttons für jeden Trade
- Performance Metriken in Realtime
- Reward Weight Adjustment Sliders
- Trade History Tabelle
"

# 8. Review und Optimierung
claude-code review src/ --suggest-improvements
claude-code optimize src/env.py --for performance

echo "=== Development Session Complete ==="
EOF

chmod +x example_session.sh

# 9. ERSTELLE QUICK START GUIDE
# ------------------------------
cat > QUICK_START.md << 'EOF'
# Quick Start Guide für Claude Code + RL Trading

## 1. Installation
```bash
# Claude Code installieren
pip install claude-code

# Projekt Dependencies
pip install -r requirements.txt

# Environment Variables
cp .env.template .env
# Edit .env mit deinen API Keys
```

## 2. Erstes Training (ohne Claude Code)
```bash
# Starte einfaches Training
python src/main.py --mode demo

# Mit Human Feedback
python src/main.py --mode interactive
```

## 3. Mit Claude Code entwickeln
```bash
# Claude Code initialisieren
claude-code init

# Context laden
claude-code context .claude-context.md

# Neues Feature hinzufügen (Beispiel)
claude-code add "Implementiere Golden Cross Pattern Detection"

# Live Coding Session
claude-code interactive --focus trading-patterns
```

## 4. Typischer Workflow

### Morgen: Pattern Research
```bash
claude-code research "Welche Trading Patterns funktionieren gut mit RL?"
claude-code implement --pattern "Order Flow Imbalance"
```

### Mittag: Backtesting
```bash
claude-code backtest --strategy latest --data last-30-days
claude-code analyze-results --suggest-improvements
```

### Abend: Human Feedback Session
```bash
python src/main.py --mode interactive
# Trade manually und gib Feedback
# Claude Code nutzt das Feedback für Verbesserungen
```

## 5. Hilfreiche Claude Code Befehle

```bash
# Was kann der Agent gerade?
claude-code explain src/agent.py

# Warum macht er bestimmte Trades?
claude-code debug "Warum kauft der Agent immer bei runden Zahlen?"

# Performance verbessern
claude-code optimize --target "Higher Sharpe Ratio"

# Neue Idee testen
claude-code experiment "Was wenn wir Reward nur bei Gewinn-Trades geben?"
```

## Tips für Claude Code:
1. Sei spezifisch in deinen Prompts
2. Gib Kontext über deine Trading-Strategie
3. Nutze --files flag um relevante Dateien anzugeben
4. Iteriere in kleinen Schritten
5. Lass Claude Code Tests schreiben!
EOF

echo ""
echo "=== Setup Complete! ==="
echo ""
echo "Nächste Schritte:"
echo "1. cd rl-trading-system"
echo "2. pip install -r requirements.txt"
echo "3. claude-code init"
echo "4. claude-code context .claude-context.md"
echo "5. Starte mit: ./example_session.sh"
echo ""
echo "Projekt ist bereit für Claude Code!"
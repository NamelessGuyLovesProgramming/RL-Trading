<!DOCTYPE html>
<html>
<head>
    <title>RL Trading Chart - Standalone</title>
    <meta charset="utf-8">
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div id="chart_container" style="width: 100%; height: 450px; background: #000;"></div>

    <script>
        console.log('üöÄ Standalone Chart gestartet');

        let chart;
        let candlestickSeries;
        let isInitialized = false;

        // Chart initialisieren
        function initChart() {
            if (isInitialized) return;

            chart = LightweightCharts.createChart(document.getElementById('chart_container'), {
                width: 800,
                height: 450,
                layout: {
                    backgroundColor: '#000000',
                    textColor: '#d9d9d9'
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                    borderColor: '#485c7b'
                },
                grid: {
                    vertLines: { visible: false },
                    horzLines: { visible: false }
                }
            });

            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#089981',
                downColor: '#f23645',
                borderUpColor: '#089981',
                borderDownColor: '#f23645',
                wickUpColor: '#089981',
                wickDownColor: '#f23645'
            });

            isInitialized = true;
            console.log('‚úÖ Chart initialisiert');
        }

        // Daten setzen
        function setChartData(data) {
            if (!isInitialized) initChart();

            candlestickSeries.setData(data);
            chart.timeScale().fitContent();
            console.log('‚úÖ Chart-Daten gesetzt:', data.length, 'Kerzen');
        }

        // Neue Kerze hinzuf√ºgen
        function updateChart(newCandle) {
            if (!isInitialized) {
                console.warn('‚ö†Ô∏è Chart nicht initialisiert f√ºr Update');
                return;
            }

            candlestickSeries.update(newCandle);
            console.log('‚úÖ Chart aktualisiert:', newCandle);
        }

        // localStorage Polling f√ºr Updates von Streamlit
        function checkForUpdates() {
            try {
                // Check f√ºr initiale Daten
                const initialData = localStorage.getItem('chartInitialData');
                if (initialData && !isInitialized) {
                    const data = JSON.parse(initialData);
                    setChartData(data);
                    localStorage.removeItem('chartInitialData');
                }

                // Check f√ºr Updates
                const pendingUpdate = localStorage.getItem('pendingChartUpdate');
                const lastProcessed = localStorage.getItem('lastChartUpdateProcessed') || '0';

                if (pendingUpdate) {
                    const updateData = JSON.parse(pendingUpdate);
                    const updateTimestamp = updateData.timestamp || '0';

                    if (updateTimestamp > lastProcessed) {
                        updateChart(updateData.candle);
                        localStorage.setItem('lastChartUpdateProcessed', updateTimestamp);
                        localStorage.removeItem('pendingChartUpdate');
                    }
                }
            } catch (e) {
                console.error('‚ùå Error in update check:', e);
            }
        }

        // Starte Update-Polling
        setInterval(checkForUpdates, 100);

        // Cleanup
        window.addEventListener('beforeunload', function() {
            localStorage.removeItem('pendingChartUpdate');
            localStorage.removeItem('lastChartUpdateProcessed');
            localStorage.removeItem('chartInitialData');
        });

        console.log('üîÑ Standalone Chart bereit f√ºr Updates');
    </script>
</body>
</html>
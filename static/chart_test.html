<!DOCTYPE html>
<html>
<head>
    <title>Chart Test - Diagnose</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        #chart_container { width: 100%; height: 400px; }
        .toolbar { margin: 10px 0; }
        .tool-btn { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        .tool-btn.active { background: #28a745; }
        .console { background: #f8f9fa; padding: 10px; margin: 10px 0; border: 1px solid #ddd; height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>üîß Chart Diagnose Tool</h1>

    <div class="toolbar">
        <button id="positionBoxTool" class="tool-btn">üì¶ Position Box</button>
        <button id="clearAll" class="tool-btn">üóëÔ∏è Clear All</button>
        <button id="testBasic" class="tool-btn">üß™ Test Basic Chart</button>
        <button id="testPosition" class="tool-btn">üß™ Test Position Box</button>
    </div>

    <div id="chart_container"></div>

    <div class="console" id="console">
        <strong>üìä Test Console:</strong><br>
    </div>

    <script>
        // Console Logger
        function log(message, type = 'info') {
            const console_div = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            console_div.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            console_div.scrollTop = console_div.scrollHeight;
            console.log(message);
        }

        // Error Handler
        window.addEventListener('error', function(e) {
            log(`‚ùå JavaScript Error: ${e.error.message} at line ${e.lineno}`, 'error');
        });

        // Chart Variables
        let chart = null;
        let candlestickSeries = null;
        let isInitialized = false;
        window.positionBoxMode = false;
        window.currentPositionBox = null;

        // Test 1: Basic Chart Initialization
        function testBasicChart() {
            log('üß™ Test 1: Basic Chart Initialization', 'info');

            try {
                const chartContainer = document.getElementById('chart_container');
                chartContainer.innerHTML = ''; // Clear previous

                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    timeScale: { timeVisible: true },
                    grid: { vertLines: { color: '#e1e1e1' }, horzLines: { color: '#e1e1e1' } }
                });

                candlestickSeries = chart.addCandlestickSeries();

                // Sample data
                const sampleData = [
                    { time: '2023-01-01', open: 100, high: 105, low: 95, close: 102 },
                    { time: '2023-01-02', open: 102, high: 108, low: 100, close: 106 },
                    { time: '2023-01-03', open: 106, high: 110, low: 104, close: 108 }
                ];

                candlestickSeries.setData(sampleData);
                log('‚úÖ Basic Chart: SUCCESS', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Basic Chart: FAILED - ${error.message}`, 'error');
                return false;
            }
        }

        // Test 2: Position Box Creation
        function testPositionBox() {
            log('üß™ Test 2: Position Box Creation', 'info');

            if (!chart || !candlestickSeries) {
                log('‚ùå Position Box: Chart not initialized', 'error');
                return false;
            }

            try {
                createPositionBox('2023-01-02', 105);
                log('‚úÖ Position Box: SUCCESS', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Position Box: FAILED - ${error.message}`, 'error');
                return false;
            }
        }

        // Position Box Function (simplified for testing)
        function createPositionBox(time, entryPrice) {
            log(`üì¶ Creating Position Box at ${time}, price: ${entryPrice}`, 'info');

            // Remove old box
            if (window.currentPositionBox) {
                removeCurrentPositionBox();
            }

            const riskPercent = 0.01;
            const rewardPercent = 0.02;
            const stopLoss = entryPrice * (1 - riskPercent);
            const takeProfit = entryPrice * (1 + rewardPercent);

            // Create box object
            window.currentPositionBox = {
                id: 'POS_' + Date.now(),
                entryPrice: entryPrice,
                stopLoss: stopLoss,
                takeProfit: takeProfit,
                time: time
            };

            // Test Canvas Creation
            createCanvasOverlay();
            drawPositionBox();

            log(`üì¶ Position Box created: Entry=${entryPrice}, SL=${stopLoss.toFixed(2)}, TP=${takeProfit.toFixed(2)}`, 'success');
        }

        function createCanvasOverlay() {
            log('üé® Creating Canvas Overlay', 'info');

            const oldCanvas = document.getElementById('position-canvas');
            if (oldCanvas) oldCanvas.remove();

            const chartContainer = document.getElementById('chart_container');
            const canvas = document.createElement('canvas');
            canvas.id = 'position-canvas';
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'auto';
            canvas.style.zIndex = '1000';
            canvas.width = chartContainer.clientWidth;
            canvas.height = chartContainer.clientHeight;

            chartContainer.style.position = 'relative';
            chartContainer.appendChild(canvas);

            window.positionCanvas = canvas;
            window.positionCtx = canvas.getContext('2d');

            log('‚úÖ Canvas Overlay created', 'success');
        }

        function drawPositionBox() {
            log('üñºÔ∏è Drawing Position Box', 'info');

            const box = window.currentPositionBox;
            const ctx = window.positionCtx;
            const canvas = window.positionCanvas;

            if (!box || !ctx || !canvas) {
                log('‚ùå Draw: Missing box, context, or canvas', 'error');
                return;
            }

            try {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Simple rectangle test (fixed positions)
                const x1 = 50;
                const x2 = 300;
                const entryY = 200;
                const slY = 250;
                const tpY = 150;

                // Draw SL Box (red)
                ctx.fillStyle = 'rgba(242, 54, 69, 0.2)';
                ctx.strokeStyle = '#f23645';
                ctx.lineWidth = 2;
                ctx.fillRect(x1, entryY, x2 - x1, slY - entryY);
                ctx.strokeRect(x1, entryY, x2 - x1, slY - entryY);

                // Draw TP Box (green)
                ctx.fillStyle = 'rgba(8, 153, 129, 0.2)';
                ctx.strokeStyle = '#089981';
                ctx.fillRect(x1, tpY, x2 - x1, entryY - tpY);
                ctx.strokeRect(x1, tpY, x2 - x1, entryY - tpY);

                // Draw Entry Line
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x1, entryY);
                ctx.lineTo(x2, entryY);
                ctx.stroke();

                log('‚úÖ Position Box drawn successfully', 'success');

            } catch (error) {
                log(`‚ùå Draw Error: ${error.message}`, 'error');
            }
        }

        function removeCurrentPositionBox() {
            const canvas = document.getElementById('position-canvas');
            if (canvas) canvas.remove();
            window.currentPositionBox = null;
            log('üóëÔ∏è Position Box removed', 'info');
        }

        // Event Handlers
        document.getElementById('testBasic').addEventListener('click', testBasicChart);
        document.getElementById('testPosition').addEventListener('click', testPositionBox);
        document.getElementById('clearAll').addEventListener('click', removeCurrentPositionBox);

        document.getElementById('positionBoxTool').addEventListener('click', function() {
            window.positionBoxMode = !window.positionBoxMode;
            this.classList.toggle('active');
            log(`üì¶ Position Box Mode: ${window.positionBoxMode ? 'ON' : 'OFF'}`, 'info');
        });

        // Auto-run basic test
        log('üöÄ Chart Test Tool loaded', 'success');
        log('üëÜ Click "Test Basic Chart" to start', 'info');

    </script>
</body>
</html>
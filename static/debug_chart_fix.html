<!DOCTYPE html>
<html>
<head>
    <title>NQ Chart Debug - Fixed Version</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chart { width: 100%; height: 600px; border: 1px solid #ccc; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>NQ Chart Debug - Fixed Version</h1>
    <div class="status info" id="status">Status: Initialisiere...</div>
    <div id="chart"></div>

    <script>
        const statusDiv = document.getElementById('status');

        function updateStatus(message, type = 'info') {
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `Status: ${message}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function loadChart() {
            try {
                updateStatus('Erstelle LightweightCharts Chart...', 'info');

                // Chart Container prüfen
                const chartContainer = document.getElementById('chart');
                if (!chartContainer) {
                    throw new Error('Chart Container nicht gefunden');
                }

                // Chart erstellen
                const chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 600,
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false
                    },
                    grid: {
                        vertLines: { color: '#e1e1e1' },
                        horzLines: { color: '#e1e1e1' }
                    },
                    layout: {
                        background: { color: '#ffffff' },
                        textColor: '#333333'
                    }
                });

                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350'
                });

                updateStatus('Chart erstellt. Lade NQ-Daten vom Server...', 'info');

                // Server Status prüfen
                const statusResponse = await fetch('/api/chart/status');
                if (!statusResponse.ok) {
                    throw new Error(`Server Status Error: ${statusResponse.status}`);
                }

                const statusData = await statusResponse.json();
                updateStatus(`Server Status OK. Verfügbare Kerzen: ${statusData.chart_state?.candles_count || 0}`, 'info');

                // Chart-Daten laden
                const dataResponse = await fetch('/api/chart/data');
                if (!dataResponse.ok) {
                    throw new Error(`Chart Data Error: ${dataResponse.status}`);
                }

                const chartData = await dataResponse.json();

                if (!chartData.data || !Array.isArray(chartData.data)) {
                    throw new Error('Ungültige Chart-Daten Struktur');
                }

                if (chartData.data.length === 0) {
                    throw new Error('Keine Chart-Daten empfangen');
                }

                updateStatus(`Daten empfangen: ${chartData.data.length} Kerzen. Konvertiere für LightweightCharts...`, 'info');

                // Daten für LightweightCharts konvertieren
                const formattedData = chartData.data.map((item, index) => {
                    try {
                        // Zeit-Konvertierung - genau wie im Server
                        const timestamp = Math.floor(new Date(item.time).getTime() / 1000);

                        return {
                            time: timestamp,
                            open: parseFloat(item.open),
                            high: parseFloat(item.high),
                            low: parseFloat(item.low),
                            close: parseFloat(item.close)
                        };
                    } catch (e) {
                        console.error(`Fehler bei Kerze ${index}:`, e, item);
                        throw new Error(`Daten-Konvertierung fehlgeschlagen bei Kerze ${index}`);
                    }
                });

                // Validierung der konvertierten Daten
                const firstCandle = formattedData[0];
                const lastCandle = formattedData[formattedData.length - 1];

                console.log('Erste Kerze:', firstCandle);
                console.log('Letzte Kerze:', lastCandle);

                // Daten an Chart übertragen
                candlestickSeries.setData(formattedData);
                chart.timeScale().fitContent();

                updateStatus(`✅ SUCCESS: ${formattedData.length} NQ-Kerzen erfolgreich geladen!`, 'success');

                // Debug Info
                console.log('Chart erfolgreich geladen:', {
                    totalCandles: formattedData.length,
                    firstCandle: firstCandle,
                    lastCandle: lastCandle,
                    symbol: chartData.symbol,
                    interval: chartData.interval
                });

                // Window resize handler
                window.addEventListener('resize', () => {
                    chart.applyOptions({
                        width: chartContainer.clientWidth,
                        height: 600
                    });
                });

            } catch (error) {
                updateStatus(`❌ FEHLER: ${error.message}`, 'error');
                console.error('Chart Loading Error:', error);
                console.error('Error Stack:', error.stack);
            }
        }

        // Chart laden wenn Seite bereit ist
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadChart);
        } else {
            loadChart();
        }
    </script>
</body>
</html>